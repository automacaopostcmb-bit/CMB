<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerador de Post</title>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Relief&display=swap" rel="stylesheet">
  <style>
    /* Base responsiva */
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 24px;
      min-height: 100dvh;
      display: block;
      background-color: #e6f0ff;
    }

    /* Tipografia */
    h2, h3 { margin: 0 0 14px 0; text-align: center; }

    /* Campos e botões (inputs) */
    input, textarea, button {
      width: 100%;
      max-width: 420px;
      margin: 10px auto;
      padding: 12px;
      font-size: 16px;
      box-sizing: border-box;
      display: block;
    }

    /* Canvas e sliders */
    canvas {
      margin: 20px auto;
      width: 100%;
      max-width: 500px;
      height: auto;
      border: 1px solid #ccc;
      display: block;
    }
    input[type="range"] {
      width: 100%;
      max-width: 500px;
      margin: 6px auto 12px;
      display: block;
    }

    /* Faixas de seção */
    .faixa-secao {
      width: 100%;
      background-color: #00BFFF;
      padding: 12px 0;
      text-align: center;
      margin: 16px 0;
    }
    .faixa-secao span { color: #fff; font-size: 22px; font-weight: bold; }

    .title-label {
      font-weight: bold;
      font-size: 16px;
      display: block;
      margin-top: 15px;
      margin-bottom: 6px;
      color: #333;
      text-align: center;
    }
    .hint {
      font-size: 13px;
      color: #444;
      margin-bottom: 10px;
      text-align: center;
    }

    .link-voltar {
      display: block;
      width: 100%;
      max-width: 420px;
      margin: 8px auto 16px;
      text-align: center;
      color: #007bff;
      font-size: 14px;
      text-decoration: none;
    }
    .link-voltar:hover { text-decoration: underline; }

    #mensagem {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }

    @media (min-width: 768px) {
      input, textarea, button, .link-voltar { max-width: 520px; }
      canvas { max-width: 640px; }
    }

    #avisoTexto {
      color: red;
      font-size: 13px;
      margin: 10px auto;
      text-align: center;
      display: none;
      max-width: 600px;
    }

    /* Wizard */
    .step { display: none; }
    .step.active { display: block; }

    #wizard-indicator {
      text-align:center;
      font-size:14px;
      margin: 8px 0 0;
      color:#333;
    }

    /* ===== Botões de navegação centralizados ===== */
    .button-row {
      display: flex;
      justify-content: center;   /* SEMPRE centraliza */
      align-items: center;
      gap: 16px;                 /* espaço entre os botões */
      margin: 20px auto 0;
      width: 100%;
      max-width: 520px;          /* largura agradável/centralizada */
    }

    /* estilos individuais (pode customizar à vontade) */
    .btn-nav {
      width: auto;               /* não ocupa 100% */
      min-width: 160px;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-voltar { background:#ddd; color:#333; }
    .btn-proximo { background:#4dafff; color:#fff; }
    .btn-proximo:disabled { background:#aacfff; cursor:not-allowed; }

    /* botão verde "Baixar Imagem" sempre centralizado */
    .btn-download {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      padding: 10px 16px;
      display: block;
      margin: 20px auto; /* centralizar */
      width: 260px;
    }

    /* realce inválido */
    .invalid {
      outline: 2px solid #ff4d4f;
      border-color: #ff4d4f !important;
      background: #fff7f7;
    }
  </style>
</head>

<body>
  <a class="link-voltar" href="index.html?back=1">Voltar</a>
  <div id="wizard-indicator">Etapa 1 de 5</div>

  <!-- ETAPA 1: Sobre você (só PRÓXIMO) -->
  <section class="step active" id="step1">
    <div class="faixa-secao"><span>Sobre você:</span></div>

    <label class="title-label">Seu nome:</label>
    <input type="text" id="nome" placeholder="" />

    <label class="title-label">E-mail:</label>
    <input type="email" id="email" placeholder="seu@email.com" />

    <label class="title-label">Número de telefone</label>
    <input type="tel" id="telefone" name="telefone" pattern="\(\d{2}\) \d{4,5}-\d{4}" placeholder="(00) 00000-0000" />

    <label class="title-label">Vai ministrar alguma Master Class no Comic Learning?</label>
    <div class="hint">(Se sim, digite o nome da aula, se não deixe vazio)</div>
    <input type="text" id="masterclass" placeholder="" />

    <label class="title-label">Vai fazer alguma dinâmica no palco?</label>
    <div class="hint">(Se sim, digite o nome da dinâmica, se não deixe vazio)</div>
    <input type="text" id="palco" placeholder="" />

    <div class="button-row">
      <button class="btn-nav btn-proximo" data-next>Próximo</button>
    </div>
  </section>

  <!-- ETAPA 2: Empresa (VOLTA + PRÓXIMO, CENTRALIZADOS) -->
  <section class="step" id="step2">
    <div class="faixa-secao"><span>Sobre sua empresa:</span></div>

    <label class="title-label">Nome da sua empresa:</label>
    <input type="text" id="empresa" placeholder="" />

    <label class="title-label">Site:</label>
    <div class="hint">(Cole o link do seu site)</div>
    <input type="text" id="site" placeholder="" />

    <label class="title-label">Instagram:</label>
    <div class="hint">(Escreva o seu @, não o link)</div>
    <input type="text" id="insta" placeholder="@" />

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Próximo</button>
    </div>
  </section>

  <!-- ETAPA 3: Imagens (VOLTA + PRÓXIMO, CENTRALIZADOS) -->
  <section class="step" id="step3">
    <div class="faixa-secao"><span>Imagens</span></div>

    <label class="title-label">Envie o seu Logo:</label>
    <div class="hint">(Use uma imagem com fundo transparente)</div>
    <input type="file" id="logo" accept="image/*" />

    <label class="title-label">Escolha uma imagem de apoio:</label>
    <div class="hint">(Qual outra imagem poderíamos usar para mostrar mais de você?)</div>
    <input type="file" id="lateral" accept="image/*" />

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Próximo</button>
    </div>
  </section>

  <!-- ETAPA 4: Preview e textos curtos (VOLTA + PRÓXIMO, CENTRALIZADOS) -->
  <section class="step" id="step4">
    <div class="faixa-secao"><span>Vamos criar a sua divulgação!</span></div>

    <label class="title-label">Tamanho da imagem de apoio</label>
    <input type="range" id="imgScale" min="0.1" max="2" step="0.01" value="1" />

    <label class="title-label">Mover horizontalmente</label>
    <input type="range" id="imgX" min="-500" max="500" value="0" />

    <label class="title-label">Mover verticalmente</label>
    <input type="range" id="imgY" min="-500" max="500" value="0" />

    <canvas id="canvas" width="1080" height="1350"></canvas>

    <div id="avisoTexto">
      * Ups, seu texto ultrapassou da caixa. Por favor ajuste!
    </div>

    <label class="title-label">Aqui é o seu título! Nos diga, o que você faz?</label>
    <div class="hint">(Pense como se fosse um título chamativo do seu trabalho)</div>
    <input type="text" id="titulo" placeholder="Título" />

    <label class="title-label">Descreva um pouco mais </label>
    <div class="hint"></div>
    <textarea id="descricao" rows="4" placeholder=""></textarea>

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Próximo</button>
    </div>
  </section>

  <!-- ETAPA 5: Bio e envio (só VOLTAR) -->
  <section class="step" id="step5">
    <label class="title-label">Escreva a sua Bio</label>
    <div class="hint">(Aqui não tem limite de caracteres. Vamos usar essas informações para divulgação)</div>
    <textarea id="descricaolonga" rows="8" placeholder=""></textarea>

    <label class="title-label">Tem alguma outra imagem para nos mandar? </label>
    <div class="hint">(Pode ser uma arte, uma foto sua em outro evento... Fique à vontade!)</div>
    <input type="file" id="background" accept="image/*" />

    <button id="botao-download" class="btn-download" onclick="baixarImagem()" style="display:none;">
      Baixar Imagem
    </button>

    <button id="botao-enviar" onclick="enviarParaGoogle()">Enviar informações</button>

    <div id="mensagem" style="margin-top: 10px; font-weight: bold;"></div>

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
    </div>
  </section>

  <!-- ====== Scripts desenho/preview ====== -->
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // URL do frame via CDN com CORS liberado
    const FRAME_URL = 'https://cdn.jsdelivr.net/gh/automacaopostcmb-bit/CMB@main/Frame.png';

    const frameImg = new Image();
    frameImg.crossOrigin = 'anonymous';
    frameImg.referrerPolicy = 'no-referrer';
    frameImg.onload = gerarPost;
    frameImg.onerror = () => {
      const m = document.getElementById('mensagem');
      if (m) {
        m.style.display = 'block';
        m.style.color = 'red';
        m.textContent = '❌ Não consegui carregar a moldura.';
      }
      console.error('Falha ao carregar frame:', FRAME_URL);
    };
    frameImg.src = FRAME_URL + '?v=' + Date.now(); // anti-cache em testes

    let logoImg, lateralImg;

    document.getElementById('logo').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        logoImg = new Image();
        logoImg.onload = gerarPost;
        logoImg.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    document.getElementById('lateral').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        lateralImg = new Image();
        lateralImg.onload = () => gerarPost();
        lateralImg.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    ['imgScale', 'imgX', 'imgY', 'titulo', 'descricao'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', gerarPost);
    });

    document.fonts?.ready?.then(gerarPost);

    function gerarPost() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Imagem lateral
      if (lateralImg) {
        const scale = parseFloat(document.getElementById('imgScale').value);
        const anchorPointX = 150;
        const anchorPointY = 1000;
        const offsetX = parseInt(document.getElementById('imgX').value);
        const offsetY = parseInt(document.getElementById('imgY').value);
        const w = lateralImg.width * scale;
        const h = lateralImg.height * scale;
        const drawX = anchorPointX + offsetX - w / 2;
        const drawY = anchorPointY + offsetY - h / 2;
        ctx.drawImage(lateralImg, drawX, drawY, w, h);
      }

      // Moldura
      if (frameImg.complete && frameImg.naturalWidth) {
        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      }

      // Logo
      if (logoImg) {
        const maxWidth = 500;
        const maxHeight = 350;
        const scale = Math.min(maxWidth / logoImg.width, maxHeight / logoImg.height);
        const width = logoImg.width * scale;
        const height = logoImg.height * scale;
        const centerY = 450;
        ctx.drawImage(logoImg, (canvas.width - width) / 2, centerY - height / 2, width, height);
      }

      // Título
      const titulo = document.getElementById('titulo').value || '';
      ctx.font = 'bold 48px "Comic Relief"';
      ctx.fillStyle = '#FFFFFF';
      ctx.textAlign = 'left';

      const tituloX = 400;
      const tituloYBase = 880;
      const tituloMaxWidth = 600;
      const tituloMaxLinhas = 2;

      const todasLinhasTitulo = wrapText(titulo, tituloMaxWidth, ctx);
      const ultrapassouTitulo = todasLinhasTitulo.length > tituloMaxLinhas;
      const linhasTitulo = todasLinhasTitulo.slice(0, tituloMaxLinhas);

      let offsetY = 0;
      if (linhasTitulo.length === 1) offsetY = 30;

      linhasTitulo.forEach((linha, i) => {
        ctx.fillText(linha, tituloX, tituloYBase + i * 54 + offsetY);
      });

      // Descrição curta
      const descricao = document.getElementById('descricao').value || '';
      ctx.font = '28px "Comic Relief"';
      ctx.fillStyle = '#333333';

      const descricaoX = 400;
      const descricaoY = 1050;
      const descricaoMaxWidth = 600;
      const descricaoMaxLinhas = 5;

      const linhasManuais = descricao.split('\n');
      let todasLinhasDescricao = [];
      linhasManuais.forEach(linha => {
        const quebradas = wrapText(linha, descricaoMaxWidth, ctx);
        todasLinhasDescricao.push(...quebradas);
      });

      const ultrapassouDescricao = todasLinhasDescricao.length > descricaoMaxLinhas;
      const linhasDescricao = todasLinhasDescricao.slice(0, descricaoMaxLinhas);

      linhasDescricao.forEach((linha, i) => {
        ctx.fillText(linha, descricaoX, descricaoY + i * 40);
      });

      document.getElementById('avisoTexto').style.display =
        (ultrapassouTitulo || ultrapassouDescricao) ? 'block' : 'none';
    }

    function wrapText(text, maxWidth, context) {
      const palavras = text.split(' ');
      const linhas = [];
      let linha = '';

      palavras.forEach(palavra => {
        const teste = linha + palavra + ' ';
        const largura = context.measureText(teste).width;
        if (largura > maxWidth && linha !== '') {
          linhas.push(linha.trim());
          linha = palavra + ' ';
        } else {
          linha = teste;
        }
      });

      if (linha !== '') linhas.push(linha.trim());
      return linhas;
    }

    function baixarImagem() {
      const link = document.createElement('a');
      link.download = 'post.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>

  <!-- Envio -->
  <script>
    async function enviarParaGoogle() {
      const camposObrigatorios = ['nome', 'email', 'telefone', 'empresa', 'site', 'insta', 'logo', 'lateral', 'titulo', 'descricaolonga', 'descricao'];
      let camposVazios = [];

      camposObrigatorios.forEach(id => {
        const el = document.getElementById(id);
        const valor = (el && el.type !== 'file') ? el.value?.trim() : (el && el.files && el.files.length ? 'ok' : '');
        if (!valor) camposVazios.push(id);
      });

      if (camposVazios.length > 0) {
        const msg = document.getElementById('mensagem');
        msg.textContent = '❌ Preencha todos os campos obrigatórios.';
        msg.style.color = 'red';
        msg.style.display = 'block';
        return;
      }

      const toBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });

      async function processarImagem(inputId) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return null;
        const base64 = await toBase64(file);
        return { name: file.name, type: file.type, content: base64.split(',')[1] };
      }

      const logoBase64 = await processarImagem('logo');
      const lateralBase64 = await processarImagem('lateral');
      const backgroundBase64 = await processarImagem('background');

      let previewBase64 = null;
      if (canvas) {
        const previewDataURL = canvas.toDataURL('image/png');
        previewBase64 = { name: 'preview.png', type: 'image/png', content: previewDataURL.split(',')[1] };
      }

      const dados = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value,
        masterclass: document.getElementById('masterclass').value,
        palco: document.getElementById('palco').value,
        empresa: document.getElementById('empresa').value,
        site: document.getElementById('site').value,
        insta: document.getElementById('insta').value,
        titulo: document.getElementById('titulo').value,
        descricao: document.getElementById('descricao').value,
        descricaolonga: document.getElementById('descricaolonga').value,
        logo: logoBase64,
        lateral: lateralBase64,
        background: backgroundBase64,
        preview: previewBase64
      };

      const overlay = document.getElementById('overlay');
      overlay.style.display = 'flex';

      const response = await fetch("https://script.google.com/macros/s/AKfycbwYlIt_E3FnscPe3Pos3JEPmDvzu3SuPNrrwUqukTsjtT973GP_HLwxfDr3jpvC423Beg/exec", {
        method: "POST",
        body: JSON.stringify(dados)
      });

      const result = await response.json();
      console.log(result);

      const msg = document.getElementById('mensagem');
      msg.style.display = 'block';

      if (result.status === 'success') {
        msg.textContent = '✅ Enviado com sucesso!';
        msg.style.color = 'green';
        document.getElementById('botao-enviar').style.display = 'none';
        document.getElementById('botao-download').style.display = 'inline-block';
      } else {
        msg.textContent = '❌ Erro ao enviar: ' + result.message;
        msg.style.color = 'red';
      }

      overlay.style.display = 'none';
      setTimeout(() => { msg.textContent = ''; }, 5000);
    }
  </script>

  <!-- Autenticação -->
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby9W9w8NwLNpyX2XSegURIX5Z2qkJAyYskXePVggOwG6wJhquDFoY7jR91p_YmOyoDmVA/exec";
    const PAGINA  = "expo_market";

    (async function(){
      const chave = (localStorage.getItem("chave") || "").trim();
      if (!chave) {
        alert("Faça login primeiro.");
        window.location.href = "index.html";
        return;
      }
      const resp = await fetch(`${API_URL}?chave=${encodeURIComponent(chave)}&pagina=${encodeURIComponent(PAGINA)}`);
      const data = await resp.json();
      if (!data.permitido) {
        alert("Você não tem permissão para acessar esta página.");
        window.location.href = "index.html";
      }
    })();
  </script>

  <!-- Wizard Controller (com validação por etapa e botões centralizados) -->
  <script>
    // Configure os campos obrigatórios por etapa
    const REQUIRED_BY_STEP = {
      1: ['nome','email','telefone'],
      2: ['empresa','site','insta'],
      3: ['logo','lateral'],
      4: ['titulo','descricao'],
      5: ['descricaolonga'] // torne opcional removendo daqui
    };

    const steps = Array.from(document.querySelectorAll('.step'));
    const totalSteps = steps.length;
    let currentStep = 1;

    function isFilled(id) {
      const el = document.getElementById(id);
      if (!el) return true;
      if (el.type === 'file') return el.files && el.files.length > 0;
      return (el.value || '').trim().length > 0;
    }

    function markValidity(ids = []) {
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('invalid');
        if (!isFilled(id)) el.classList.add('invalid');
      });
    }

    function validateStep(stepNumber) {
      const req = REQUIRED_BY_STEP[stepNumber] || [];
      markValidity(req);
      return req.every(isFilled);
    }

    function updateIndicator() {
      const ind = document.getElementById('wizard-indicator');
      if (ind) ind.textContent = `Etapa ${currentStep} de ${totalSteps}`;
    }

    function showStep(n) {
      currentStep = Math.max(1, Math.min(totalSteps, n));
      steps.forEach((el, idx) => el.classList.toggle('active', idx === currentStep - 1));
      updateIndicator();

      // habilita/desabilita botão Próximo conforme validação
      const activeStep = steps[currentStep - 1];
      const nextBtn = activeStep.querySelector('[data-next]');
      if (nextBtn) nextBtn.disabled = !validateStep(currentStep);

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Revalida enquanto o usuário digita/anexa
    document.addEventListener('input', (e) => {
      const activeStep = steps[currentStep - 1];
      if (!activeStep.contains(e.target)) return;
      const nextBtn = activeStep.querySelector('[data-next]');
      if (nextBtn) nextBtn.disabled = !validateStep(currentStep);
    });
    document.addEventListener('change', (e) => {
      const activeStep = steps[currentStep - 1];
      if (!activeStep.contains(e.target)) return;
      const nextBtn = activeStep.querySelector('[data-next]');
      if (nextBtn) nextBtn.disabled = !validateStep(currentStep);
    });

    // Navegação
    document.addEventListener('click', (e) => {
      if (e.target.matches('[data-next]')) {
        if (validateStep(currentStep)) showStep(currentStep + 1);
      }
      if (e.target.matches('[data-prev]')) {
        showStep(currentStep - 1);
      }
    });

    // inicia no passo 1
    showStep(1);
  </script>

  <!-- Overlay -->
  <div id="overlay" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    color: #000;
    font-weight: bold;">
    Enviando...
  </div>
</body>
</html>
