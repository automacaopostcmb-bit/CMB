<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Gerador de Post</title>

  <!-- Fonte usada no canvas -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Relief&display=swap" rel="stylesheet">

  <style>
    /* =========================
       ESTILOS GERAIS / LAYOUT
       ========================= */
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 24px;
      min-height: 100dvh;
      background-color: #e6f0ff;
    }

    h1, h2, h3 { text-align: center; margin: 0 0 14px 0; }

    /* Inputs / Textareas / Buttons padr√£o (form) */
    input, textarea, button {
      width: 100%;
      max-width: 420px;
      margin: 10px auto;
      padding: 12px;
      font-size: 16px;
      box-sizing: border-box;
      display: block;
    }

    /* Sliders e Canvas */
    input[type="range"] {
      width: 100%;
      max-width: 500px;
      margin: 6px auto 12px;
      display: block;
    }
    canvas {
      margin: 20px auto;
      width: 100%;
      max-width: 500px;
      height: auto;
      border: 1px solid #ccc;
      display: block;
      background: #fff;
    }

    /* Faixa azul de se√ß√£o (t√≠tulo de cada etapa) */
    .faixa-secao {
      width: 100%;
      background-color: #00BFFF;
      padding: 12px 0;
      text-align: center;
      margin: 16px 0;
    }
    .faixa-secao span { color: #fff; font-size: 22px; font-weight: bold; }

    /* Labels / dicas */
    .title-label {
      font-weight: bold;
      font-size: 16px;
      display: block;
      margin-top: 15px;
      margin-bottom: 6px;
      color: #333;
      text-align: center;
    }
    .hint {
      font-size: 13px;
      color: #444;
      margin-bottom: 10px;
      text-align: center;
    }

    /* Link opcional de volta (topo) */
    .link-voltar {
      display: block;
      width: 100%;
      max-width: 520px;
      margin: 8px auto 16px;
      text-align: center;
      color: #007bff;
      font-size: 14px;
      text-decoration: none;
    }
    .link-voltar:hover { text-decoration: underline; }

    /* Mensagem geral (sucesso/erro de envio) */
    #mensagem {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }

    @media (min-width: 768px) {
      input, textarea, button, .link-voltar { max-width: 520px; }
      canvas { max-width: 640px; }
    }

    /* Aviso de overflow do texto do canvas */
    #avisoTexto {
      color: red;
      font-size: 13px;
      margin: 10px auto;
      text-align: center;
      display: none;      /* aparece quando estoura */
      max-width: 600px;
    }

    /* =========================
       WIZARD (FORM EM ETAPAS)
       ========================= */
    .step { display: none; }          /* cada etapa come√ßa oculta */
    .step.active { display: block; }  /* etapa atual vis√≠vel */

    /* Indicador "Etapa X de Y" */
    #wizard-indicator {
      text-align:center;
      font-size:14px;
      margin: 8px 0 0;
      color:#333;
    }

    /* Linha de bot√µes SEMPRE centralizada (1 ou 2 bot√µes) */
    .button-row {
      display: flex;
      justify-content: center;   /* centraliza sempre */
      align-items: center;
      gap: 16px;                 /* espa√ßo entre bot√µes quando houver 2 */
      margin: 20px auto 0;
      width: 100%;
      max-width: 520px;
    }

    /* Estilos dos bot√µes de navega√ß√£o */
    .btn-nav {
      width: auto;
      min-width: 160px;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-voltar { background:#ddd; color:#333; }
    .btn-proximo { background:#4dafff; color:#fff; }
    .btn-proximo:disabled { background:#aacfff; cursor:not-allowed; }

    /* Bot√£o "Baixar Imagem" ‚Äî centralizado em QUALQUER CONTEXTO */
    .btn-download {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      padding: 10px 16px;
      width: 260px;
      display: block;
      margin: 20px auto; /* garante centro */
    }

    /* Realce de campo inv√°lido */
    .invalid {
      outline: 2px solid #ff4d4f;
      border-color: #ff4d4f !important;
      background: #fff7f7;
    }

    /* Caixa visual da introdu√ß√£o */
    .intro-box {
      max-width: 720px;
      margin: 24px auto 0;
      background: #ffffff;
      border: 1px solid #d9e7ff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.04);
    }
    .intro-box h2 { margin-top: 4px; }
    .intro-box p {
      line-height: 1.5;
      margin: 10px 0;
      color: #333;
      font-size: 15px;
      text-align: left;
    }

    /* =========================
       TELA FINAL P√ìS-ENVIO
       ========================= */
    .final-screen { display: none; } /* s√≥ aparece ap√≥s sucesso */
    .final-card {
      max-width: 720px;
      margin: 24px auto 0;
      background: #ffffff;
      border: 1px solid #d9e7ff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.04);
      text-align: center;
    }
    .btn-menu {
      background: #505bda;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      padding: 10px 16px;
      width: 260px;
      display: block;
      margin: 10px auto 0;
    }
  </style>
</head>

<body>
  <!-- Link de retorno (escondido na tela final) -->
  <a class="link-voltar" id="link-topo" href="index.html?back=1">Voltar</a>

  <!-- Indicador da etapa (escondido na tela final) -->
  <div id="wizard-indicator">Etapa 1 de 6</div>

  <!-- =================================
       ETAPA 1 ‚Äî INTRODU√á√ÉO (APENAS PR√ìXIMO)
       ================================= -->
  <section class="step active" id="step1">
    <div class="faixa-secao"><span>Boas-vindas</span></div>

    <!-- üîß PERSONALIZE ESSE TEXTO -->
    <div id="intro-content" class="intro-box">
      <h2>Bem-vindo(a) ao Gerador de Post do Comic Learning üéâ</h2>
      <p>
        Preencha seus dados e envie os arquivos. No fim, voc√™ poder√° fazer o
        download da imagem gerada. Se o texto do <strong>Preview</strong> extrapolar a √°rea,
        um aviso aparecer√° e o bot√£o <em>Pr√≥ximo</em> ficar√° desabilitado at√© voc√™ ajustar.
      </p>
      <p>
        Clique em <strong>Pr√≥ximo</strong> para come√ßar!
      </p>
    </div>

    <div class="button-row">
      <button class="btn-nav btn-proximo" data-next>Pr√≥ximo</button>
    </div>
  </section>

  <!-- =================================
       ETAPA 2 ‚Äî SOBRE VOC√ä
       ================================= -->
  <section class="step" id="step2">
    <div class="faixa-secao"><span>Sobre voc√™:</span></div>

    <label class="title-label">Seu nome:</label>
    <input type="text" id="nome" placeholder="" />

    <label class="title-label">E-mail:</label>
    <input type="email" id="email" placeholder="seu@email.com" />

    <label class="title-label">N√∫mero de telefone</label>
    <input type="tel" id="telefone" name="telefone"
           pattern="\(\d{2}\) \d{4,5}-\d{4}" placeholder="(00) 00000-0000" />

    <label class="title-label">Vai ministrar alguma Master Class no Comic Learning?</label>
    <div class="hint">(Se sim, digite o nome da aula, se n√£o deixe vazio)</div>
    <input type="text" id="masterclass" placeholder="" />

    <label class="title-label">Vai fazer alguma din√¢mica no palco?</label>
    <div class="hint">(Se sim, digite o nome da din√¢mica, se n√£o deixe vazio)</div>
    <input type="text" id="palco" placeholder="" />

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Pr√≥ximo</button>
    </div>
  </section>

  <!-- =================================
       ETAPA 3 ‚Äî EMPRESA
       ================================= -->
  <section class="step" id="step3">
    <div class="faixa-secao"><span>Sobre sua empresa:</span></div>

    <label class="title-label">Nome da sua empresa:</label>
    <input type="text" id="empresa" placeholder="" />

    <label class="title-label">Site:</label>
    <div class="hint">(Cole o link do seu site)</div>
    <input type="text" id="site" placeholder="" />

    <label class="title-label">Instagram:</label>
    <div class="hint">(Escreva o seu @, n√£o o link)</div>
    <input type="text" id="insta" placeholder="@" />

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Pr√≥ximo</button>
    </div>
  </section>

  <!-- =================================
       ETAPA 4 ‚Äî IMAGENS (UPLOADS)
       ================================= -->
  <section class="step" id="step4">
    <div class="faixa-secao"><span>Imagens</span></div>

    <label class="title-label">Envie o seu Logo:</label>
    <div class="hint">(Use uma imagem com fundo transparente)</div>
    <input type="file" id="logo" accept="image/*" />

    <label class="title-label">Escolha uma imagem de apoio:</label>
    <div class="hint">(Qual outra imagem poder√≠amos usar para mostrar mais de voc√™?)</div>
    <input type="file" id="lateral" accept="image/*" />

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Pr√≥ximo</button>
    </div>
  </section>

  <!-- =================================
       ETAPA 5 ‚Äî PREVIEW / T√çTULO / DESCRI√á√ÉO
       ================================= -->
  <section class="step" id="step5">
    <div class="faixa-secao"><span>Vamos criar a sua divulga√ß√£o!</span></div>

    <label class="title-label">Tamanho da imagem de apoio</label>
    <input type="range" id="imgScale" min="0.1" max="2" step="0.01" value="1" />

    <label class="title-label">Mover horizontalmente</label>
    <input type="range" id="imgX" min="-500" max="500" value="0" />

    <label class="title-label">Mover verticalmente</label>
    <input type="range" id="imgY" min="-500" max="500" value="0" />

    <canvas id="canvas" width="1080" height="1350"></canvas>

    <div id="avisoTexto">
      * Ups, seu texto ultrapassou da caixa. Por favor ajuste!
    </div>

    <label class="title-label">Aqui √© o seu t√≠tulo! Nos diga, o que voc√™ faz?</label>
    <div class="hint">(Pense como se fosse um t√≠tulo chamativo do seu trabalho)</div>
    <input type="text" id="titulo" placeholder="T√≠tulo" />

    <label class="title-label">Descreva um pouco mais</label>
    <textarea id="descricao" rows="4" placeholder=""></textarea>

    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
      <button class="btn-nav btn-proximo" data-next>Pr√≥ximo</button>
    </div>
  </section>

  <!-- =================================
       ETAPA 6 ‚Äî BIO / ENVIO (APENAS VOLTAR)
       ================================= -->
  <section class="step" id="step6">
    <label class="title-label">Escreva a sua Bio</label>
    <div class="hint">(Aqui n√£o tem limite de caracteres. Vamos usar essas informa√ß√µes para divulga√ß√£o)</div>
    <textarea id="descricaolonga" rows="8" placeholder=""></textarea>

    <label class="title-label">Tem alguma outra imagem para nos mandar?</label>
    <div class="hint">(Pode ser uma arte, uma foto sua em outro evento... Fique √† vontade!)</div>
    <input type="file" id="background" accept="image/*" />

    <!-- Bot√£o de envio (centralizado pela largura padr√£o dos buttons) -->
    <button id="botao-enviar" onclick="enviarParaGoogle()">Enviar informa√ß√µes</button>

    <!-- Mensagens de sucesso/erro do envio -->
    <div id="mensagem"></div>

    <!-- √öltima etapa ‚Üí s√≥ Voltar -->
    <div class="button-row">
      <button class="btn-nav btn-voltar" data-prev>Voltar</button>
    </div>
  </section>

  <!-- =================================
       TELA FINAL (P√ìS-ENVIO) ‚Äî sem classe .step
       ================================= -->
  <section id="final-screen" class="final-screen">
    <div class="final-card">
      <h2>‚úÖ Enviado com sucesso!</h2>
      <p>Obrigado por enviar suas informa√ß√µes. Voc√™ j√° pode baixar a imagem.</p>

      <!-- Bot√µes finais: SEMPRE centralizados -->
      <button class="btn-download" id="btn-final-download" onclick="baixarImagem()">
        Baixar Imagem
      </button>
      <button class="btn-menu" id="btn-menu" onclick="window.location.href='index.html'">
        Menu
      </button>
    </div>
  </section>

  <!-- =======================================================================
       SCRIPTS: PREVIEW/CANVAS, ENVIO, AUTENTICA√á√ÉO E WIZARD (MODULAR)
       ======================================================================= -->

  <!-- ========== 1) PREVIEW / CANVAS  ========== -->
  <script>
    // Refer√™ncias do canvas
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Moldura (via CDN com CORS habilitado)
    const FRAME_URL = 'https://cdn.jsdelivr.net/gh/automacaopostcmb-bit/CMB@main/Frame.png';

    // Estado de valida√ß√£o global (modular)
    const validationFlags = {
      overflow: false, // true quando t√≠tulo/descri√ß√£o passam do limite (bloqueia Pr√≥ximo)
    };

    // Carrega a moldura
    const frameImg = new Image();
    frameImg.crossOrigin = 'anonymous';
    frameImg.referrerPolicy = 'no-referrer';
    frameImg.onload = gerarPost;
    frameImg.onerror = () => {
      const m = document.getElementById('mensagem');
      if (m) {
        m.style.display = 'block';
        m.style.color = 'red';
        m.textContent = '‚ùå N√£o consegui carregar a moldura.';
      }
      console.error('Falha ao carregar frame:', FRAME_URL);
    };
    frameImg.src = FRAME_URL + '?v=' + Date.now(); // anti-cache para testes

    // Imagens do usu√°rio
    let logoImg, lateralImg;

    // Leitura do logo
    document.getElementById('logo').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        logoImg = new Image();
        logoImg.onload = gerarPost;
        logoImg.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    // Leitura da imagem lateral
    document.getElementById('lateral').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        lateralImg = new Image();
        lateralImg.onload = gerarPost;
        lateralImg.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    // Eventos para atualizar o preview em tempo real
    ['imgScale', 'imgX', 'imgY', 'titulo', 'descricao'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', gerarPost);
    });

    // Garante fonte carregada antes de medir texto
    document.fonts?.ready?.then(gerarPost);

    // Desenha o preview
    function gerarPost() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Imagem de apoio (posicion√°vel)
      if (lateralImg) {
        const scale = parseFloat(document.getElementById('imgScale').value || '1');
        const anchorPointX = 150;
        const anchorPointY = 1000;
        const offsetX = parseInt(document.getElementById('imgX').value || '0', 10);
        const offsetY = parseInt(document.getElementById('imgY').value || '0', 10);

        const w = lateralImg.width * scale;
        const h = lateralImg.height * scale;
        const drawX = anchorPointX + offsetX - w / 2;
        const drawY = anchorPointY + offsetY - h / 2;

        ctx.drawImage(lateralImg, drawX, drawY, w, h);
      }

      // Moldura
      if (frameImg.complete && frameImg.naturalWidth) {
        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      }

      // Logo centralizado
      if (logoImg) {
        const maxWidth = 500;
        const maxHeight = 350;
        const scale = Math.min(maxWidth / logoImg.width, maxHeight / logoImg.height);
        const width = logoImg.width * scale;
        const height = logoImg.height * scale;
        const centerY = 450;
        ctx.drawImage(logoImg, (canvas.width - width) / 2, centerY - height / 2, width, height);
      }

      // T√≠tulo (branco)
      const titulo = (document.getElementById('titulo').value || '').trim();
      ctx.font = 'bold 48px "Comic Relief"';
      ctx.fillStyle = '#FFFFFF';
      ctx.textAlign = 'left';

      const tituloX = 400;
      const tituloYBase = 880;
      const tituloMaxWidth = 600;
      const tituloMaxLinhas = 2;

      const todasLinhasTitulo = wrapText(titulo, tituloMaxWidth, ctx);
      const ultrapassouTitulo = todasLinhasTitulo.length > tituloMaxLinhas;
      const linhasTitulo = todasLinhasTitulo.slice(0, tituloMaxLinhas);

      let offsetY = 0;
      if (linhasTitulo.length === 1) offsetY = 30;

      linhasTitulo.forEach((linha, i) => {
        ctx.fillText(linha, tituloX, tituloYBase + i * 54 + offsetY);
      });

      // Descri√ß√£o (preto)
      const descricao = (document.getElementById('descricao').value || '').trim();
      ctx.font = '28px "Comic Relief"';
      ctx.fillStyle = '#333333';

      const descricaoX = 400;
      const descricaoY = 1050;
      const descricaoMaxWidth = 600;
      const descricaoMaxLinhas = 5;

      const linhasManuais = descricao.split('\n');
      let todasLinhasDescricao = [];
      linhasManuais.forEach(linha => {
        const quebradas = wrapText(linha, descricaoMaxWidth, ctx);
        todasLinhasDescricao.push(...quebradas);
      });

      const ultrapassouDescricao = todasLinhasDescricao.length > descricaoMaxLinhas;
      const linhasDescricao = todasLinhasDescricao.slice(0, descricaoMaxLinhas);

      linhasDescricao.forEach((linha, i) => {
        ctx.fillText(linha, descricaoX, descricaoY + i * 40);
      });

      // Flag de overflow para bloquear o Pr√≥ximo via validador
      validationFlags.overflow = (ultrapassouTitulo || ultrapassouDescricao);

      // Aviso e realce
      const aviso = document.getElementById('avisoTexto');
      aviso.style.display = validationFlags.overflow ? 'block' : 'none';
      document.getElementById('titulo')?.classList.toggle('invalid', ultrapassouTitulo);
      document.getElementById('descricao')?.classList.toggle('invalid', ultrapassouDescricao);

      // Revalida bot√£o "Pr√≥ximo" (etapa atual)
      if (typeof revalidateStepNav === 'function') revalidateStepNav();
    }

    // Quebra de texto por largura
    function wrapText(text, maxWidth, context) {
      const palavras = text.split(' ');
      const linhas = [];
      let linha = '';

      palavras.forEach(palavra => {
        const teste = linha + palavra + ' ';
        const largura = context.measureText(teste).width;
        if (largura > maxWidth && linha !== '') {
          linhas.push(linha.trim());
          linha = palavra + ' ';
        } else {
          linha = teste;
        }
      });

      if (linha !== '') linhas.push(linha.trim());
      return linhas;
    }

    // Download do canvas
    function baixarImagem() {
      const link = document.createElement('a');
      link.download = 'post.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>

  <!-- ========== 2) ENVIO (Google Apps Script)  ========== -->
  <script>
    async function enviarParaGoogle() {
      // Checagem final de obrigat√≥rios (server-side voc√™ confere tamb√©m)
      const camposObrigatorios = [
        'nome', 'email', 'telefone',
        'empresa', 'site', 'insta',
        'logo', 'lateral',
        'titulo', 'descricao',
        'descricaolonga'
      ];

      let camposVazios = [];
      camposObrigatorios.forEach(id => {
        const el = document.getElementById(id);
        const valor = (el && el.type !== 'file')
          ? (el.value || '').trim()
          : (el && el.files && el.files.length ? 'ok' : '');
        if (!valor) camposVazios.push(id);
      });

      if (camposVazios.length > 0) {
        const msg = document.getElementById('mensagem');
        msg.textContent = '‚ùå Preencha todos os campos obrigat√≥rios.';
        msg.style.color = 'red';
        msg.style.display = 'block';
        return;
      }

      // Helpers p/ arquivos
      const toBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });

      async function processarImagem(inputId) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return null;
        const base64 = await toBase64(file);
        return { name: file.name, type: file.type, content: base64.split(',')[1] };
      }

      // Prepara anexos
      const logoBase64 = await processarImagem('logo');
      const lateralBase64 = await processarImagem('lateral');
      const backgroundBase64 = await processarImagem('background');

      // Preview final (canvas)
      let previewBase64 = null;
      if (canvas) {
        const previewDataURL = canvas.toDataURL('image/png');
        previewBase64 = { name: 'preview.png', type: 'image/png', content: previewDataURL.split(',')[1] };
      }

      // Payload
      const dados = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value,
        masterclass: document.getElementById('masterclass').value,
        palco: document.getElementById('palco').value,
        empresa: document.getElementById('empresa').value,
        site: document.getElementById('site').value,
        insta: document.getElementById('insta').value,
        titulo: document.getElementById('titulo').value,
        descricao: document.getElementById('descricao').value,
        descricaolonga: document.getElementById('descricaolonga').value,
        logo: logoBase64,
        lateral: lateralBase64,
        background: backgroundBase64,
        preview: previewBase64
      };

      // Overlay "Enviando..."
      const overlay = document.getElementById('overlay');
      overlay.style.display = 'flex';

      // Envia para seu Apps Script (troque a URL se necess√°rio)
      const response = await fetch("https://script.google.com/macros/s/AKfycbwYlIt_E3FnscPe3Pos3JEPmDvzu3SuPNrrwUqukTsjtT973GP_HLwxfDr3jpvC423Beg/exec", {
        method: "POST",
        body: JSON.stringify(dados)
      });

      const result = await response.json();
      console.log(result);

      const msg = document.getElementById('mensagem');
      msg.style.display = 'block';

      if (result.status === 'success') {
        // Mensagem de sucesso (ainda na etapa 6, antes de esconder)
        msg.textContent = '‚úÖ Enviado com sucesso!';
        msg.style.color = 'green';

        // üî• Mostra a TELA FINAL e esconde o restante do wizard
        document.getElementById('step6').style.display = 'none';       // esconde √∫ltima etapa
        document.getElementById('wizard-indicator').style.display = 'none';
        document.getElementById('link-topo').style.display = 'none';
        document.getElementById('final-screen').style.display = 'block'; // exibe tela final

        // Sobe a p√°gina para o topo
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        msg.textContent = '‚ùå Erro ao enviar: ' + (result.message || 'Tente novamente.');
        msg.style.color = 'red';
      }

      overlay.style.display = 'none';
      // (Opcional) limpar mensagem depois de alguns segundos
      setTimeout(() => { msg.textContent = ''; }, 5000);
    }
  </script>

  <!-- ========== 3) AUTENTICA√á√ÉO (seu Apps Script) ========== -->
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby9W9w8NwLNpyX2XSegURIX5Z2qkJAyYskXePVggOwG6wJhquDFoY7jR91p_YmOyoDmVA/exec";
    const PAGINA  = "expo_market";

    (async function(){
      const chave = (localStorage.getItem("chave") || "").trim();
      if (!chave) {
        alert("Fa√ßa login primeiro.");
        window.location.href = "index.html";
        return;
      }
      const resp = await fetch(`${API_URL}?chave=${encodeURIComponent(chave)}&pagina=${encodeURIComponent(PAGINA)}`);
      const data = await resp.json();
      if (!data.permitido) {
        alert("Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.");
        window.location.href = "index.html";
      }
    })();
  </script>

  <!-- ========== 4) WIZARD CONTROLLER (modular) ========== -->
  <script>
    /* -----------------------------------------------------
       CONFIG: CAMPOS OBRIGAT√ìRIOS E VALIDADORES
       ----------------------------------------------------- */

    // Agora temos 6 etapas (1 intro + 5 do formul√°rio)
    const REQUIRED_BY_STEP = {
      1: [],                             // Intro
      2: ['nome','email','telefone'],    // Sobre voc√™
      3: ['empresa','site','insta'],     // Empresa
      4: ['logo','lateral'],             // Imagens
      5: ['titulo','descricao'],         // Preview
      6: ['descricaolonga']              // Bio/Envio (torne opcional removendo daqui)
    };

    // Validadores globais (rodam em TODAS as etapas, se quiser)
    const GLOBAL_VALIDATORS = [
      // exemplo (desativado):
      // (step) => (document.getElementById('insta')?.value || '').length <= 50
    ];

    // Validadores espec√≠ficos por etapa
    const STEP_VALIDATORS = {
      // Etapa 5: bloqueia Pr√≥ximo se t√≠tulo/descri√ß√£o estourarem a caixa (canvas)
      5: () => !validationFlags.overflow
    };

    /* -----------------------------------------------------
       MOTOR DO WIZARD
       ----------------------------------------------------- */

    const steps = Array.from(document.querySelectorAll('.step'));
    const totalSteps = steps.length; // 6
    let currentStep = 1;

    // Campo preenchido?
    function isFilled(id) {
      const el = document.getElementById(id);
      if (!el) return true;
      if (el.type === 'file') return el.files && el.files.length > 0;
      return (el.value || '').trim().length > 0;
    }

    // Real√ßa campos inv√°lidos
    function markValidity(ids = []) {
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('invalid');
        if (!isFilled(id)) el.classList.add('invalid');
      });
    }

    // Valida√ß√£o completa da etapa
    function validateStep(stepNumber) {
      const required = REQUIRED_BY_STEP[stepNumber] || [];
      markValidity(required);

      // 1) Obrigat√≥rios
      let ok = required.every(isFilled);
      if (!ok) return false;

      // 2) Valida√ß√µes globais
      for (const fn of GLOBAL_VALIDATORS) {
        if (fn && fn(stepNumber) === false) return false;
      }

      // 3) Validador espec√≠fico da etapa (se houver)
      const stepFn = STEP_VALIDATORS[stepNumber];
      if (stepFn && stepFn() === false) return false;

      return true;
    }

    // Habilita/desabilita "Pr√≥ximo"
    function revalidateStepNav() {
      const activeStep = steps[currentStep - 1];
      const nextBtn = activeStep?.querySelector('[data-next]');
      if (nextBtn) nextBtn.disabled = !validateStep(currentStep);
    }

    // Atualiza "Etapa X de Y"
    function updateIndicator() {
      const ind = document.getElementById('wizard-indicator');
      if (ind) ind.textContent = `Etapa ${currentStep} de ${totalSteps}`;
    }

    // Troca de etapa
    function showStep(n) {
      currentStep = Math.max(1, Math.min(totalSteps, n));
      steps.forEach((el, idx) => el.classList.toggle('active', idx === currentStep - 1));
      updateIndicator();
      revalidateStepNav();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Revalida conforme usu√°rio digita/anexa
    document.addEventListener('input', (e) => {
      const activeStep = steps[currentStep - 1];
      if (!activeStep?.contains(e.target)) return;
      revalidateStepNav();
    });
    document.addEventListener('change', (e) => {
      const activeStep = steps[currentStep - 1];
      if (!activeStep?.contains(e.target)) return;
      revalidateStepNav();
    });

    // Navega√ß√£o
    document.addEventListener('click', (e) => {
      if (e.target.matches('[data-next]')) {
        if (validateStep(currentStep)) showStep(currentStep + 1);
      }
      if (e.target.matches('[data-prev]')) {
        showStep(currentStep - 1);
      }
    });

    // Inicia no passo 1 (Intro)
    showStep(1);
  </script>

  <!-- Overlay "Enviando..." -->
  <div id="overlay" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    color: #000;
    font-weight: bold;">
    Enviando...
  </div>
</body>
</html>
